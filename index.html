<!DOCTYPE html>
<html>
  <head>
    <title>Robot Simulator - Drag & Reset</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #2f3542;
        color: white;
      }
      #canvas {
        width: 600px;
        height: 300px;
        background: #f1f2f6;
        border: 4px solid #57606f;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        border-radius: 10px;
      }
      #robot {
        width: 50px;
        height: 50px;
        background: #ff4757;
        position: absolute;
        left: 100px;
        top: 125px;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 10px;
        font-weight: bold;
        border: 2px solid #333;
        cursor: grab; /* สัญลักษณ์มือลาก */
        user-select: none;
        touch-action: none;
        z-index: 10;
      }
      #robot:active {
        cursor: grabbing;
      }
      .wheel {
        width: 10px;
        height: 10px;
        background: #2f3542;
        position: absolute;
        border-radius: 2px;
      }
      .w-l {
        top: -5px;
      }
      .w-r {
        bottom: -5px;
      }
      #editor-container {
        width: 600px;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        color: #333;
      }
      textarea {
        width: 100%;
        height: 120px;
        font-family: "Consolas", monospace;
        padding: 10px;
        border: 2px solid #ced4da;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }
      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }
      #run-btn {
        background: #2ed573;
        color: white;
      }
      #reset-btn {
        background: #eccc68;
        color: #333;
      }
      #status {
        margin-top: 10px;
        font-size: 14px;
        color: #a4b0be;
      }
    </style>
  </head>
  <body>
    <h2>Robot Drag & Control</h2>

    <div id="canvas">
      <div id="robot" id="robot">
        <div class="wheel w-l"></div>
        DRAG ME
        <div class="wheel w-r"></div>
      </div>
    </div>

    <div id="editor-container">
      <textarea id="codeEditor">
motor(60, 20);
delay(3000);
motor(0, 0);
      </textarea>

      <div class="controls">
        <button id="run-btn" onclick="runCode()">Run Program</button>
        <button id="reset-btn" onclick="resetPosition()">Reset Position</button>
      </div>
      <div id="status">Status: Ready (Try dragging the robot)</div>
    </div>

    <script src="https://neil.fraser.name/software/JS-Interpreter/acorn_interpreter.js"></script>

    <script>
      const robot = document.getElementById("robot");
      const canvas = document.getElementById("canvas");
      const statusDiv = document.getElementById("status");

      const START_X = 100;
      const START_Y = 125;
      const START_ANGLE = 0;

      let robotX = START_X;
      let robotY = START_Y;
      let angle = START_ANGLE;
      let motorL = 0;
      let motorR = 0;
      let isRunning = false;
      let isDragging = false;
      let myInterpreter = null;

      // --- ระบบ Drag & Drop ---
      robot.addEventListener("mousedown", (e) => {
        if (isRunning) return; // ห้ามลากขณะโปรแกรมทำงาน
        isDragging = true;
        robot.style.transition = "none"; // ปิด transition ขณะลาก
      });

      window.addEventListener("mousemove", (e) => {
        if (!isDragging) return;

        const rect = canvas.getBoundingClientRect();
        // คำนวณตำแหน่งเมาส์เทียบกับพื้นที่ Canvas
        robotX = e.clientX - rect.left - 25;
        robotY = e.clientY - rect.top - 25;

        // อัปเดตตำแหน่ง DOM
        updateRobotDOM();
      });

      window.addEventListener("mouseup", () => {
        isDragging = false;
      });

      // --- ฟังก์ชันอัปเดตหน้าจอ ---
      function updateRobotDOM() {
        robot.style.left = robotX + "px";
        robot.style.top = robotY + "px";
        robot.style.transform = `rotate(${angle}deg)`;
      }

      function resetPosition() {
        isRunning = false;
        robotX = START_X;
        robotY = START_Y;
        angle = START_ANGLE;
        motorL = 0;
        motorR = 0;
        updateRobotDOM();
        statusDiv.innerText = "Status: Position Reset";
      }

      // --- Game Loop ---
      function updatePhysics() {
        if (isRunning && !isDragging) {
          const turnSpeed = (motorL - motorR) * 0.05;
          angle += turnSpeed;

          const speed = (motorL + motorR) / 100;
          const radians = angle * (Math.PI / 180);

          robotX += speed * Math.cos(radians);
          robotY += speed * Math.sin(radians);

          updateRobotDOM();

          if (robotX > 550 || robotX < 0 || robotY > 250 || robotY < 0) {
            stopRobot("Collided with Wall!");
          }
        }
        requestAnimationFrame(updatePhysics);
      }

      function stopRobot(msg) {
        isRunning = false;
        motorL = 0;
        motorR = 0;
        statusDiv.innerText = "Status: " + msg;
      }

      // --- Interpreter Setup ---
      function initApi(interpreter, globalObject) {
        interpreter.setProperty(
          globalObject,
          "motor",
          interpreter.createNativeFunction((l, r) => {
            motorL = l;
            motorR = r;
            statusDiv.innerText = `Status: Motor (${l}, ${r})`;
          })
        );

        interpreter.setProperty(
          globalObject,
          "delay",
          interpreter.createAsyncFunction((ms, callback) => {
            setTimeout(callback, ms);
          })
        );
      }

      function runCode() {
        if (isDragging) return;

        // ไม่มีการรีเซ็ตพิกัดตรงนี้แล้ว จะเริ่มจากจุดปัจจุบัน
        isRunning = true;
        const code = document.getElementById("codeEditor").value;

        try {
          myInterpreter = new Interpreter(code, initApi);
          function step() {
            if (isRunning && myInterpreter.step()) {
              setTimeout(step, 1);
            } else if (!myInterpreter.step()) {
              stopRobot("Program Finished");
            }
          }
          step();
        } catch (e) {
          alert("Error: " + e);
          stopRobot("Error");
        }
      }

      // เริ่มทำงาน
      updatePhysics();
    </script>
  </body>
</html>
